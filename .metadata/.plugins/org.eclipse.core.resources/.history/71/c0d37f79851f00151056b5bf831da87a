/*
 * app.c
 *
 *  Created on: Jun 23, 2015
 *      Author: abubakr
 */
#include "app.h"

void APP_Init(void)
{
	UART_Init();
    LCD_init();

}

void app(void){

}

void defaultScreen(void){
	LCD_displayStringRowColumn(0,0,"+ : Change Pass");
	LCD_displayStringRowColumn(1,0,"- : Open Door");
}

uint8 authRequest(void){
	uint8 response ,* entredPasswd;
	LCD_clearScreen();
	LCD_displayStringRowColumn(0,0,"Enter Your Paswd");
	_delay_ms(500);

	entredPasswd=enter_Passwd();

// send option to MC2 for auth

	while(UART_RecieveByte() != M2_READY){} // wait until MC2 is ready
	UART_SendByte(AUTH);

// send the password the user entered to MC2 to check it.

	while(UART_RecieveByte() != M2_READY){} // wait until MC2 is ready
	UART_SendString(entredPasswd);

// receive the authentication result from MC2

	UART_SendByte(M2_READY); // MC2 is ready
	response = UART_RecieveByte();



	if (response == 0x01){
		return (1);
	}
	else {
		return (0);
	}
}


void changePassword(void){

	uint8 wrongCount=0;
	while(!authRequest() & wrongCount <3){
		++wrongCount;

		LCD_clearScreen();
		LCD_displayCharacter('0'+wrongCount);
		_delay_ms(500);


	}
	if (wrongCount==3){
		alert();
	}
	else{
		while (set_Passwd()){
			set_Passwd();
		}
	}
	defaultScreen();
}

void alert(void){

	while(UART_RecieveByte() != M2_READY){} // wait until MC2 is ready
	UART_SendByte(ALERT);

	LCD_clearScreen();
	LCD_displayString("Alert");
	_delay_ms(60000);

	defaultScreen();
}

void openDoor(void){
	if (authRequest()){

	while(UART_RecieveByte() != M2_READY){} // wait until MC2 is ready
	UART_SendByte(OPEN_DOOR);

	LCD_clearScreen();
	LCD_displayString("DOOR IS OPENING");
	_delay_ms(5000);
	LCD_clearScreen();
	LCD_displayString("DOOR IS CLOSING");
	_delay_ms(5000);

	}

	defaultScreen();

}
